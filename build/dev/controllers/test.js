"use strict";var mongoose=require("mongoose"),test=mongoose.model("test"),core=require("../../libs/core"),config=require("../../config"),_=require("underscore"),funDeltest=function(obj,res,mess){obj.remove(function(err){return err?core.resJson(res,{type:0,message:core.getErrorMessage(err)}):void core.resJson(res,{type:1,message:"删除成功"})})},funEdittest=function(obj,res,mess){obj.save(function(err,result){return err||!result?core.resJson(res,{type:0,message:core.getErrorMessage(err)}):void core.resJson(res,{type:1,message:mess+"成功",data:result})})};exports.addtest=function(req,res){console.log(req.method+"======test controller addtest ======"+new Date);var obj=req.body;if(obj){var test=new test(obj);funEdittest(test,res)}},exports.deltest=function(req,res){console.log(req.method+"======test controller deltest ======"+new Date);var id=req.params.id;id?test.findById(id).populate("author").exec(function(err,result){return err?core.resJson(res,{type:0,message:core.getErrorMessage(err)}):result?void funDeltest(result,res):core.resJson(res,{type:0,message:"查询对象不存在"})}):core.resJson(res,{type:0,message:"参数获取失败"})},exports.edittest=function(req,res){console.log(req.method+"======test controller edittest ======"+new Date);var id=req.params.id,obj=req.body;id&&obj?test.findById(id).populate("author").exec(function(err,result){return err?core.resJson(res,{type:0,message:core.getErrorMessage(err)}):result?(_.extend(result,obj),void funEdittest(result,res)):core.resJson(res,{type:0,message:"查询对象不存在"})}):core.resJson(res,{type:0,message:"参数获取失败"})},exports.listtest=function(req,res){console.log(req.method+"======test controller list ======"+new Date);var condition={},nameParams=req.query.name;nameParams&&(condition.name=new RegExp(nameParams)),test.count(condition,function(err,total){if(console.log("test总数=="+total),err)return core.resJson(res,{type:0,message:core.getErrorMessage(err)});var query=test.find(condition).populate("author"),pageInfo=core.createPage(req,total,10);pageInfo.countItems=total,console.log("test============分页参数============"),console.log(pageInfo),query.skip(pageInfo.start),query.limit(pageInfo.pageSize),query.sort({created:-1}),query.exec(function(err,results){var obj={type:1,message:"查询成功",pages:pageInfo,rows:results};core.resJson(res,obj,"list")})})},exports.viewtest=function(req,res){console.log(req.method+"======test controller viewtest ======"+new Date);var id=req.params.id;id?test.findById(id).populate("author").exec(function(err,result){return err?core.resJson(res,{type:0,message:core.getErrorMessage(err)}):result?void core.resJson(res,result):core.resJson(res,{type:0,message:"查询对象不存在"})}):core.resJson(res,{type:0,message:"参数获取失败"})};